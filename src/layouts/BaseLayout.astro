---
import { getCollection } from 'astro:content';
import { Commands } from '../lib/Commands';
import SEO from '../components/SEO.astro';
import '../styles/global.css';
import Analytics from '@vercel/analytics/astro'

const { title, description, type, image } = Astro.props;

const posts = (await getCollection('blog'))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .map(post => ({
    title: post.data.title,
    href: `/${post.id}`
  }));
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.ico" sizes="32x32" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <link rel="preload" href="/fonts/Sentient-Variable.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/Sentient-VariableItalic.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/Erode-Variable.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/Erode-VariableItalic.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
    <title>{title}</title>
    {description && <SEO title={title} description={description} type={type} image={image} />}
    <!-- Dark mode initialization (blocking to prevent flash) -->
    <script is:inline>
      const scheme = localStorage.getItem('theme');
      if (!scheme) {
        const mql = window.matchMedia('(prefers-color-scheme: dark)');
        document.documentElement.classList.toggle('dark', mql.matches);
        mql.onchange = (e) => document.documentElement.classList.toggle('dark', e.matches);
      } else {
        document.documentElement.classList.toggle('dark', scheme === 'dark');
      }
    </script>
    <!-- Scrollbar detection (non-Mac only) -->
    <script is:inline>
      if (!navigator.userAgent.includes('Mac OS')) {
        document.documentElement.classList.add('bars');
      }
    </script>
  </head>
  <body class="font-[Sentient-Variable,system-ui,-apple-system,sans-serif] relative min-h-screen" style="background-color: var(--color-background); color: var(--color-foreground);">
    <div class="mx-auto max-w-3xl px-4 py-8">
      <header class="mb-8 flex items-center justify-between">
        <slot name="header-content">
          <a href="/" class="text-sm hover:underline">‚Üê back</a>
        </slot>
        <Commands client:load posts={posts} />
      </header>
      <slot />
    </div>
    <!-- Paper texture overlay -->
    <div
      style="background-image:url(/paper-light.jpeg);mix-blend-mode:multiply;opacity:0.35;"
      class="pointer-events-none fixed inset-0 z-50 select-none bg-repeat bg-[length:512px_512px] dark:hidden"
    ></div>
    <div
      style="background-image: url(/paper-dark.jpg)"
      class="pointer-events-none fixed inset-0 z-50 select-none bg-repeat bg-[length:512px_512px] opacity-5 hidden dark:block"
    ></div>
    <Analytics/> 
  </body>
</html>
